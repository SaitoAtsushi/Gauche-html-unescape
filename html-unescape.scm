(define-module html-unescape
  (export html-unescape-string)
  (use srfi-13))

(select-module html-unescape)

(define html-unescape-string
  (cut regexp-replace-all #/&([^;]{1,9});/ <>
       (lambda(m)
         (let1 str (m 1)
           (cond ((string-prefix? "#x" str)
                  (string (ucs->char (string->number (string-drop str 2) 16))))
                 ((string-prefix? "#" str)
                  (string (ucs->char (string->number (string-drop str 1) 10))))
                 ((assoc-ref entities str #f string=?)
                  => values)
                 (else (error "Invalid html string")))))))

(define entities
  '(("quot" . "\x22;")
    ("amp" . "\x26;")
    ("lt" . "\x3c;")
    ("gt" . "\x3e;")
    ("OElig" . "\x152;")
    ("oelig" . "\x153;")
    ("Scaron" . "\x160;")
    ("scaron" . "\x161;")
    ("Yuml" . "\x178;")
    ("circ" . "\x2c6;")
    ("tilde" . "\x2dc;")
    ("ensp" . "\x2002;")
    ("emsp" . "\x2003;")
    ("thinsp" . "\x2009;")
    ("zwnj" . "\x200c;")
    ("zwj" . "\x200d;")
    ("lrm" . "\x200e;")
    ("rlm" . "\x200f;")
    ("ndash" . "\x2013;")
    ("mdash" . "\x2014;")
    ("lsquo" . "\x2018;")
    ("rsquo" . "\x2019;")
    ("sbquo" . "\x201a;")
    ("ldquo" . "\x201c;")
    ("rdquo" . "\x201d;")
    ("bdquo" . "\x201e;")
    ("dagger" . "\x2020;")
    ("Dagger" . "\x2021;")
    ("permil" . "\x2030;")
    ("lsaquo" . "\x2039;")
    ("rsaquo" . "\x203a;")
    ("euro" . "\x20ac;")
    ("fnof" . "\x192;")
    ("Alpha" . "\x391;")
    ("Beta" . "\x392;")
    ("Gamma" . "\x393;")
    ("Delta" . "\x394;")
    ("Epsilon" . "\x395;")
    ("Zeta" . "\x396;")
    ("Eta" . "\x397;")
    ("Theta" . "\x398;")
    ("Iota" . "\x399;")
    ("Kappa" . "\x39a;")
    ("Lambda" . "\x39b;")
    ("Mu" . "\x39c;")
    ("Nu" . "\x39d;")
    ("Xi" . "\x39e;")
    ("Omicron" . "\x39f;")
    ("Pi" . "\x3a0;")
    ("Rho" . "\x3a1;")
    ("Sigma" . "\x3a3;")
    ("Tau" . "\x3a4;")
    ("Upsilon" . "\x3a5;")
    ("Phi" . "\x3a6;")
    ("Chi" . "\x3a7;")
    ("Psi" . "\x3a8;")
    ("Omega" . "\x3a9;")
    ("alpha" . "\x3b1;")
    ("beta" . "\x3b2;")
    ("gamma" . "\x3b3;")
    ("delta" . "\x3b4;")
    ("epsilon" . "\x3b5;")
    ("zeta" . "\x3b6;")
    ("eta" . "\x3b7;")
    ("theta" . "\x3b8;")
    ("iota" . "\x3b9;")
    ("kappa" . "\x3ba;")
    ("lambda" . "\x3bb;")
    ("mu" . "\x3bc;")
    ("nu" . "\x3bd;")
    ("xi" . "\x3be;")
    ("omicron" . "\x3bf;")
    ("pi" . "\x3c0;")
    ("rho" . "\x3c1;")
    ("sigmaf" . "\x3c2;")
    ("sigma" . "\x3c3;")
    ("tau" . "\x3c4;")
    ("upsilon" . "\x3c5;")
    ("phi" . "\x3c6;")
    ("chi" . "\x3c7;")
    ("psi" . "\x3c8;")
    ("omega" . "\x3c9;")
    ("thetasym" . "\x3d1;")
    ("upsih" . "\x3d2;")
    ("piv" . "\x3d6;")
    ("bull" . "\x2022;")
    ("hellip" . "\x2026;")
    ("prime" . "\x2032;")
    ("Prime" . "\x2033;")
    ("oline" . "\x203e;")
    ("frasl" . "\x2044;")
    ("weierp" . "\x2118;")
    ("image" . "\x2111;")
    ("real" . "\x211c;")
    ("trade" . "\x2122;")
    ("alefsym" . "\x2135;")
    ("larr" . "\x2190;")
    ("uarr" . "\x2191;")
    ("rarr" . "\x2192;")
    ("darr" . "\x2193;")
    ("harr" . "\x2194;")
    ("crarr" . "\x21b5;")
    ("lArr" . "\x21d0;")
    ("uArr" . "\x21d1;")
    ("rArr" . "\x21d2;")
    ("dArr" . "\x21d3;")
    ("hArr" . "\x21d4;")
    ("forall" . "\x2200;")
    ("part" . "\x2202;")
    ("exist" . "\x2203;")
    ("empty" . "\x2205;")
    ("nabla" . "\x2207;")
    ("isin" . "\x2208;")
    ("notin" . "\x2209;")
    ("ni" . "\x220b;")
    ("prod" . "\x220f;")
    ("sum" . "\x2211;")
    ("minus" . "\x2212;")
    ("lowast" . "\x2217;")
    ("radic" . "\x221a;")
    ("prop" . "\x221d;")
    ("infin" . "\x221e;")
    ("ang" . "\x2220;")
    ("and" . "\x2227;")
    ("or" . "\x2228;")
    ("cap" . "\x2229;")
    ("cup" . "\x222a;")
    ("int" . "\x222b;")
    ("there4" . "\x2234;")
    ("sim" . "\x223c;")
    ("cong" . "\x2245;")
    ("asymp" . "\x2248;")
    ("ne" . "\x2260;")
    ("equiv" . "\x2261;")
    ("le" . "\x2264;")
    ("ge" . "\x2265;")
    ("sub" . "\x2282;")
    ("sup" . "\x2283;")
    ("nsub" . "\x2284;")
    ("sube" . "\x2286;")
    ("supe" . "\x2287;")
    ("oplus" . "\x2295;")
    ("otimes" . "\x2297;")
    ("perp" . "\x22a5;")
    ("sdot" . "\x22c5;")
    ("lceil" . "\x2308;")
    ("rceil" . "\x2309;")
    ("lfloor" . "\x230a;")
    ("rfloor" . "\x230b;")
    ("lang" . "\x2329;")
    ("rang" . "\x232a;")
    ("loz" . "\x25ca;")
    ("spades" . "\x2660;")
    ("clubs" . "\x2663;")
    ("hearts" . "\x2665;")
    ("diams" . "\x2666;")
    ("nbsp" . "\xa0;")
    ("iexcl" . "\xa1;")
    ("cent" . "\xa2;")
    ("pound" . "\xa3;")
    ("curren" . "\xa4;")
    ("yen" . "\xa5;")
    ("brvbar" . "\xa6;")
    ("sect" . "\xa7;")
    ("uml" . "\xa8;")
    ("copy" . "\xa9;")
    ("ordf" . "\xaa;")
    ("laquo" . "\xab;")
    ("not" . "\xac;")
    ("shy" . "\xad;")
    ("reg" . "\xae;")
    ("macr" . "\xaf;")
    ("deg" . "\xb0;")
    ("plusmn" . "\xb1;")
    ("sup2" . "\xb2;")
    ("sup3" . "\xb3;")
    ("acute" . "\xb4;")
    ("micro" . "\xb5;")
    ("para" . "\xb6;")
    ("middot" . "\xb7;")
    ("cedil" . "\xb8;")
    ("sup1" . "\xb9;")
    ("ordm" . "\xba;")
    ("raquo" . "\xbb;")
    ("frac14" . "\xbc;")
    ("frac12" . "\xbd;")
    ("frac34" . "\xbe;")
    ("iquest" . "\xbf;")
    ("Agrave" . "\xc0;")
    ("Aacute" . "\xc1;")
    ("Acirc" . "\xc2;")
    ("Atilde" . "\xc3;")
    ("Auml" . "\xc4;")
    ("Aring" . "\xc5;")
    ("AElig" . "\xc6;")
    ("Ccedil" . "\xc7;")
    ("Egrave" . "\xc8;")
    ("Eacute" . "\xc9;")
    ("Ecirc" . "\xca;")
    ("Euml" . "\xcb;")
    ("Igrave" . "\xcc;")
    ("Iacute" . "\xcd;")
    ("Icirc" . "\xce;")
    ("Iuml" . "\xcf;")
    ("ETH" . "\xd0;")
    ("Ntilde" . "\xd1;")
    ("Ograve" . "\xd2;")
    ("Oacute" . "\xd3;")
    ("Ocirc" . "\xd4;")
    ("Otilde" . "\xd5;")
    ("Ouml" . "\xd6;")
    ("times" . "\xd7;")
    ("Oslash" . "\xd8;")
    ("Ugrave" . "\xd9;")
    ("Uacute" . "\xda;")
    ("Ucirc" . "\xdb;")
    ("Uuml" . "\xdc;")
    ("Yacute" . "\xdd;")
    ("THORN" . "\xde;")
    ("szlig" . "\xdf;")
    ("agrave" . "\xe0;")
    ("aacute" . "\xe1;")
    ("acirc" . "\xe2;")
    ("atilde" . "\xe3;")
    ("auml" . "\xe4;")
    ("aring" . "\xe5;")
    ("aelig" . "\xe6;")
    ("ccedil" . "\xe7;")
    ("egrave" . "\xe8;")
    ("eacute" . "\xe9;")
    ("ecirc" . "\xea;")
    ("euml" . "\xeb;")
    ("igrave" . "\xec;")
    ("iacute" . "\xed;")
    ("icirc" . "\xee;")
    ("iuml" . "\xef;")
    ("eth" . "\xf0;")
    ("ntilde" . "\xf1;")
    ("ograve" . "\xf2;")
    ("oacute" . "\xf3;")
    ("ocirc" . "\xf4;")
    ("otilde" . "\xf5;")
    ("ouml" . "\xf6;")
    ("divide" . "\xf7;")
    ("oslash" . "\xf8;")
    ("ugrave" . "\xf9;")
    ("uacute" . "\xfa;")
    ("ucirc" . "\xfb;")
    ("uuml" . "\xfc;")
    ("yacute" . "\xfd;")
    ("thorn" . "\xfe;")
    ("yuml" . "\xff;")
    ))
